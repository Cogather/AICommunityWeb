<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicommunity.mapper.ActivityRegistrationMapper">

    <resultMap id="RegistrationUserResultMap" type="com.aicommunity.dto.ActivityRegistrationResponse$RegistrationUser">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="user_name" property="userName"/>
        <result column="user_avatar" property="userAvatar"/>
        <result column="employee_id" property="employeeId"/>
        <result column="department" property="department"/>
        <result column="register_time" property="registerTime"/>
    </resultMap>

    <insert id="insert">
        INSERT INTO activity_registrations (activity_id, user_id, create_time)
        VALUES (#{activityId}, #{userId}, NOW())
    </insert>

    <delete id="deleteByUserAndActivity">
        DELETE FROM activity_registrations WHERE user_id = #{userId} AND activity_id = #{activityId}
    </delete>

    <select id="existsByUserAndActivity" resultType="boolean">
        SELECT COUNT(*) > 0 FROM activity_registrations 
        WHERE user_id = #{userId} AND activity_id = #{activityId}
    </select>

    <select id="selectUsersByActivityId" resultMap="RegistrationUserResultMap">
        SELECT ar.id, u.id as user_id, u.name as user_name, u.avatar as user_avatar,
               u.employee_id, u.department, ar.create_time as register_time
        FROM activity_registrations ar
        INNER JOIN users u ON ar.user_id = u.id
        WHERE ar.activity_id = #{activityId}
        ORDER BY ar.create_time DESC
    </select>

    <select id="countByUserId" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM activity_registrations WHERE user_id = #{userId}
    </select>

    <delete id="deleteByActivityId">
        DELETE FROM activity_registrations WHERE activity_id = #{activityId}
    </delete>

</mapper>
