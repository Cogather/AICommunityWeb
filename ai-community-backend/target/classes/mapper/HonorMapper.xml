<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicommunity.mapper.HonorMapper">

    <resultMap id="BaseResultMap" type="com.aicommunity.entity.Honor">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="award_id" property="awardId"/>
        <result column="award_name" property="awardName"/>
        <result column="award_date" property="awardDate"/>
        <result column="year" property="year"/>
        <result column="category" property="category"/>
        <result column="flowers" property="flowers"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT * FROM honors WHERE id = #{id}
    </select>

    <select id="selectHonors" resultMap="BaseResultMap">
        SELECT h.* FROM honors h
        INNER JOIN users u ON h.user_id = u.id
        WHERE 1=1
        <if test="scope == 'mine' and currentUserId != null">
            AND h.user_id = #{currentUserId}
        </if>
        <if test="user != null and user != ''">
            AND u.name = #{user}
        </if>
        <if test="filterType == 'category' and filterValue != null and filterValue != ''">
            AND h.category = #{filterValue}
        </if>
        <if test="filterType == 'award' and filterValue != null and filterValue != ''">
            AND h.award_id = #{filterValue}
        </if>
        <if test="filterType == 'year' and filterValue != null and filterValue != ''">
            AND h.year = #{filterValue}
        </if>
        <if test="search != null and search != ''">
            AND (u.name LIKE CONCAT('%', #{search}, '%') OR h.award_name LIKE CONCAT('%', #{search}, '%'))
        </if>
        <choose>
            <when test="view == 'timeline'">
                ORDER BY h.award_date DESC, h.create_time DESC
            </when>
            <otherwise>
                ORDER BY h.create_time DESC
            </otherwise>
        </choose>
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO honors (user_id, award_id, award_name, award_date, year, category, flowers, create_time)
        VALUES (#{userId}, #{awardId}, #{awardName}, #{awardDate}, #{year}, #{category}, 0, NOW())
    </insert>

    <delete id="deleteById">
        DELETE FROM honors WHERE id = #{id}
    </delete>

    <resultMap id="TopUserResultMap" type="com.aicommunity.entity.Honor$TopUser">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="avatar" property="avatar"/>
        <result column="level" property="level"/>
        <result column="department" property="department"/>
    </resultMap>

    <select id="selectTopUsers" resultMap="TopUserResultMap">
        SELECT 
            u.id,
            u.name,
            u.avatar,
            COUNT(h.id) as level,
            u.department
        FROM users u
        INNER JOIN honors h ON u.id = h.user_id
        GROUP BY u.id, u.name, u.avatar, u.department
        ORDER BY level DESC
        LIMIT #{limit}
    </select>

    <select id="countTotalHonors" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM honors
    </select>

    <select id="countTotalUsers" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT user_id) FROM honors
    </select>

    <select id="countTotalFlowers" resultType="java.lang.Integer">
        SELECT COALESCE(SUM(flowers), 0) FROM honors
    </select>

    <select id="countFlowersByUserId" resultType="java.lang.Integer">
        SELECT COALESCE(SUM(flowers), 0) FROM honors WHERE user_id = #{userId}
    </select>

    <resultMap id="CategoryStatsResultMap" type="com.aicommunity.dto.HonorInfluenceResponse$CategoryStats">
        <result column="category" property="category"/>
        <result column="count" property="count"/>
        <result column="label" property="label"/>
    </resultMap>

    <select id="selectCategoryStats" resultMap="CategoryStatsResultMap">
        SELECT 
            category,
            COUNT(*) as count,
            CASE category
                WHEN 'innovation' THEN '技术创新'
                WHEN 'efficiency' THEN '效能提升'
                WHEN 'practice' THEN '最佳实践'
                WHEN 'community' THEN '社区贡献'
                ELSE category
            END as label
        FROM honors
        GROUP BY category
        ORDER BY count DESC
    </select>

    <resultMap id="DepartmentStatsResultMap" type="com.aicommunity.dto.HonorInfluenceResponse$DepartmentStats">
        <result column="name" property="name"/>
        <result column="count" property="count"/>
    </resultMap>

    <select id="selectTopDepartments" resultMap="DepartmentStatsResultMap">
        SELECT 
            u.department as name,
            COUNT(h.id) as count
        FROM honors h
        INNER JOIN users u ON h.user_id = u.id
        WHERE u.department IS NOT NULL
        GROUP BY u.department
        ORDER BY count DESC
        LIMIT #{limit}
    </select>

    <select id="existsFlowerByUserAndHonor" resultType="boolean">
        SELECT COUNT(*) > 0 FROM honor_flowers 
        WHERE user_id = #{userId} AND honor_id = #{honorId}
    </select>

    <insert id="insertFlower">
        INSERT INTO honor_flowers (user_id, honor_id, create_time)
        VALUES (#{userId}, #{honorId}, NOW())
    </insert>

    <update id="incrementFlowers">
        UPDATE honors SET flowers = flowers + 1 WHERE id = #{id}
    </update>

</mapper>
