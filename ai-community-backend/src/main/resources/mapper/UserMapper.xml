<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicommunity.mapper.UserMapper">

    <resultMap id="BaseResultMap" type="com.aicommunity.entity.User">
        <id column="id" property="id"/>
        <result column="employee_id" property="employeeId"/>
        <result column="name" property="name"/>
        <result column="email" property="email"/>
        <result column="password" property="password"/>
        <result column="avatar" property="avatar"/>
        <result column="bio" property="bio"/>
        <result column="department" property="department"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <select id="selectByEmployeeId" resultMap="BaseResultMap">
        SELECT * FROM users WHERE employee_id = #{employeeId}
    </select>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT * FROM users WHERE id = #{id}
    </select>

    <select id="selectByName" resultMap="BaseResultMap">
        SELECT * FROM users WHERE name = #{name} LIMIT 1
    </select>

    <update id="updateById">
        UPDATE users
        SET bio = #{bio},
            avatar = #{avatar},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <select id="searchUsers" resultMap="BaseResultMap">
        SELECT DISTINCT u.* FROM users u
        <if test="role != null and role != ''">
            INNER JOIN user_roles ur ON u.id = ur.user_id AND ur.role = #{role}
        </if>
        WHERE 1=1
        <if test="employeeId != null and employeeId != ''">
            AND u.employee_id LIKE CONCAT('%', #{employeeId}, '%')
        </if>
        <if test="name != null and name != ''">
            AND u.name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="email != null and email != ''">
            AND u.email LIKE CONCAT('%', #{email}, '%')
        </if>
        LIMIT 20
    </select>

    <select id="selectUsers" resultMap="BaseResultMap">
        SELECT DISTINCT u.* FROM users u
        <if test="role != null and role != ''">
            INNER JOIN user_roles ur ON u.id = ur.user_id AND ur.role = #{role}
        </if>
        <if test="toolId != null">
            INNER JOIN user_roles ur2 ON u.id = ur2.user_id AND ur2.role = 'owner' AND ur2.tool_id = #{toolId}
        </if>
        WHERE 1=1
        <if test="search != null and search != ''">
            AND (u.name LIKE CONCAT('%', #{search}, '%') 
                 OR u.email LIKE CONCAT('%', #{search}, '%')
                 OR u.employee_id LIKE CONCAT('%', #{search}, '%'))
        </if>
        ORDER BY u.create_time DESC
    </select>

</mapper>
