# AI社区后端接口实现指南

## 项目结构说明

```
ai-community-backend/
├── src/main/java/com/aicommunity/
│   ├── common/                    # 通用组件
│   │   ├── Result.java           # 统一返回结果
│   │   ├── PageQuery.java        # 分页查询参数
│   │   ├── PageResult.java       # 分页结果
│   │   ├── exception/            # 异常处理
│   │   └── enums/                # 枚举类
│   ├── entity/                    # 实体类
│   ├── dto/                       # 数据传输对象
│   ├── mapper/                    # MyBatis Mapper接口
│   ├── service/                   # Service接口
│   │   └── impl/                  # Service实现类
│   ├── controller/                # Controller控制器
│   ├── config/                    # 配置类
│   └── util/                      # 工具类
├── src/main/resources/
│   ├── mapper/                    # MyBatis XML映射文件
│   ├── application.yml            # 主配置文件
│   └── application-dev.yml        # 开发环境配置
└── database/
    └── schema.sql                 # 数据库建表语句
```

## 核心接口实现说明

### 1. 用户认证接口

#### 1.1 POST /api/auth/login
- **Controller**: `AuthController.login()`
- **Service**: `AuthService.login()`
- **Mapper**: `UserMapper.selectByEmployeeId()`
- **实现要点**:
  - 根据工号查询用户
  - 验证密码（MD5加密）
  - 生成JWT Token
  - 返回用户信息和Token

#### 1.2 POST /api/auth/logout
- **Controller**: `AuthController.logout()`
- **Service**: `AuthService.logout()`
- **实现要点**:
  - 清除Token缓存（如使用Redis）

### 2. 用户相关接口

#### 2.1 GET /api/user/current
- **Controller**: `UserController.getCurrentUser()`
- **Service**: `UserService.getCurrentUser()`
- **Mapper**: `UserMapper.selectById()`, `UserRoleMapper.selectByUserId()`
- **实现要点**:
  - 从Token中获取用户ID
  - 查询用户基本信息
  - 查询用户角色列表
  - 统计用户数据（帖子数、收藏数、评论数等）
  - 计算用户积分

#### 2.2 GET /api/user/points/calculate
- **Controller**: `UserController.calculatePoints()`
- **Service**: `UserService.calculatePoints()`
- **Mapper**: `PointsRecordMapper.selectByUserIdAndMonth()`
- **实现要点**:
  - 查询用户本月积分记录
  - 按类型分组统计
  - 返回积分明细

#### 2.3 GET /api/user/:userId/profile
- **Controller**: `UserController.getUserProfile()`
- **Service**: `UserService.getUserProfile()`
- **实现要点**:
  - 支持通过userId或name查询
  - 返回用户完整信息

### 3. 帖子相关接口

#### 3.1 GET /api/posts
- **Controller**: `PostController.getPosts()`
- **Service**: `PostService.getPosts()`
- **Mapper**: `PostMapper.selectByCondition()`
- **实现要点**:
  - 支持多条件查询（zone、toolId、tag、department、author、sort、search）
  - 使用PageHelper实现分页
  - 支持排序（newest、hot、comments、likes）
  - 关联查询作者信息、标签信息

#### 3.2 GET /api/posts/:id
- **Controller**: `PostController.getPostDetail()`
- **Service**: `PostService.getPostDetail()`
- **Mapper**: `PostMapper.selectById()`, `LikeRecordMapper.selectByUserAndTarget()`, `FavoriteMapper.selectByUserAndPost()`
- **实现要点**:
  - 查询帖子详情
  - 增加浏览量
  - 判断当前用户是否点赞、收藏
  - 判断当前用户是否有编辑、删除权限

#### 3.3 POST /api/posts
- **Controller**: `PostController.createPost()`
- **Service**: `PostService.createPost()`
- **Mapper**: `PostMapper.insert()`, `PostTagMapper.insertBatch()`, `PointsRecordMapper.insert()`
- **实现要点**:
  - 创建帖子
  - 批量插入标签关联
  - 计算积分（发布帖子+15，管理员除外）
  - 创建积分记录

#### 3.4 PUT /api/posts/:id
- **Controller**: `PostController.updatePost()`
- **Service**: `PostService.updatePost()`
- **实现要点**:
  - 验证权限（作者或管理员）
  - 更新帖子信息
  - 更新标签关联

#### 3.5 DELETE /api/posts/:id
- **Controller**: `PostController.deletePost()`
- **Service**: `PostService.deletePost()`
- **实现要点**:
  - 验证权限
  - 删除帖子（级联删除评论、点赞、收藏记录）

#### 3.6 POST /api/posts/:id/like
- **Controller**: `PostController.likePost()`
- **Service**: `PostService.likePost()`
- **Mapper**: `LikeRecordMapper.insert()`, `PostMapper.updateLikes()`, `PointsRecordMapper.insert()`
- **实现要点**:
  - 检查是否已点赞
  - 插入点赞记录
  - 更新帖子点赞数
  - 给作者加积分（+3，管理员除外）

#### 3.7 POST /api/posts/:id/collect
- **Controller**: `PostController.collectPost()`
- **Service**: `PostService.collectPost()`
- **实现要点**:
  - 检查是否已收藏
  - 插入/删除收藏记录
  - 给作者加积分（+5，管理员除外）

### 4. 评论相关接口

#### 4.1 GET /api/posts/:id/comments
- **Controller**: `CommentController.getComments()`
- **Service**: `CommentService.getComments()`
- **Mapper**: `CommentMapper.selectByPostId()`
- **实现要点**:
  - 查询帖子评论列表（分页）
  - 查询评论的回复列表
  - 判断当前用户是否点赞

#### 4.2 POST /api/posts/:id/comments
- **Controller**: `CommentController.createComment()`
- **Service**: `CommentService.createComment()`
- **实现要点**:
  - 创建评论或回复
  - 更新帖子评论数
  - 计算积分（+1，管理员除外）
  - 发送消息通知

#### 4.3 POST /api/comments/:id/like
- **Controller**: `CommentController.likeComment()`
- **Service**: `CommentService.likeComment()`
- **实现要点**:
  - 点赞/取消点赞评论
  - 更新评论点赞数
  - 给评论作者加积分（+1，管理员除外）

### 5. 活动相关接口

#### 5.1 GET /api/activities
- **Controller**: `ActivityController.getActivities()`
- **Service**: `ActivityService.getActivities()`
- **Mapper**: `ActivityMapper.selectByCondition()`
- **实现要点**:
  - 支持多条件查询（toolId、type、status）
  - 分页查询
  - 关联查询工具信息

#### 5.2 GET /api/activities/:id
- **Controller**: `ActivityController.getActivityDetail()`
- **Service**: `ActivityService.getActivityDetail()`
- **实现要点**:
  - 查询活动详情
  - 判断当前用户是否已报名
  - 判断当前用户是否有编辑、删除权限

#### 5.3 POST /api/activities
- **Controller**: `ActivityController.createActivity()`
- **Service**: `ActivityService.createActivity()`
- **实现要点**:
  - 创建活动
  - 验证权限（工具Owner或管理员）

#### 5.4 POST /api/activities/:id/register
- **Controller**: `ActivityController.registerActivity()`
- **Service**: `ActivityService.registerActivity()`
- **实现要点**:
  - 检查是否已报名
  - 插入报名记录
  - 更新活动报名人数
  - 计算积分（+10，管理员除外）
  - 发送消息通知

### 6. 荣誉相关接口

#### 6.1 GET /api/honors
- **Controller**: `HonorController.getHonors()`
- **Service**: `HonorService.getHonors()`
- **Mapper**: `HonorMapper.selectByCondition()`
- **实现要点**:
  - 支持多条件筛选（scope、view、filterType、filterValue、search）
  - 支持分页
  - 支持时光轴视图（按年份分组）

#### 6.2 GET /api/honors/influence
- **Controller**: `HonorController.getHonorInfluence()`
- **Service**: `HonorService.getHonorInfluence()`
- **实现要点**:
  - 统计总荣誉数、总用户数、总花朵数
  - 按类别统计
  - 统计Top部门

#### 6.3 POST /api/honors/:id/flower
- **Controller**: `HonorController.giveFlower()`
- **Service**: `HonorService.giveFlower()`
- **实现要点**:
  - 检查是否已送花
  - 插入送花记录
  - 更新荣誉花朵数

### 7. 管理后台接口

#### 7.1 PUT /api/admin/home/carousel
- **Controller**: `AdminController.saveCarousel()`
- **Service**: `AdminService.saveCarousel()`
- **实现要点**:
  - 验证管理员权限
  - 删除旧配置
  - 批量插入新配置

#### 7.2 GET /api/admin/honors/recommended-winners
- **Controller**: `AdminController.getRecommendedWinners()`
- **Service**: `AdminService.getRecommendedWinners()`
- **Mapper**: `PointsRecordMapper.selectTopUsersByMonth()`
- **实现要点**:
  - 查询本月积分Top 3用户（排除管理员）
  - 统计用户本月各项数据
  - 判断是否已评奖

#### 7.3 POST /api/admin/honors
- **Controller**: `AdminController.createHonor()`
- **Service**: `AdminService.createHonor()`
- **实现要点**:
  - 验证管理员权限
  - 创建荣誉记录
  - 从获奖时间中提取年份

## 关键实现细节

### 1. 权限验证
- 使用拦截器验证Token
- 从Token中获取用户ID
- 查询用户角色，判断权限

### 2. 积分计算
- 在Service层实现积分计算逻辑
- 创建积分记录（按月统计）
- 排除管理员用户

### 3. 消息通知
- 在Service层创建消息记录
- 支持WebSocket实时推送（可选）

### 4. 分页查询
- 使用PageHelper插件
- 统一使用PageQuery和PageResult

### 5. 数据统计
- 使用SQL聚合函数统计
- 缓存热门数据（可选）

## 注意事项

1. **事务管理**: 涉及多表操作时使用`@Transactional`注解
2. **参数校验**: 使用`@Valid`和`@NotNull`等注解
3. **异常处理**: 统一使用`BusinessException`抛出业务异常
4. **日志记录**: 关键操作记录日志
5. **性能优化**: 复杂查询使用索引，避免N+1问题
