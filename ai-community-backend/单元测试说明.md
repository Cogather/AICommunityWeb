# 单元测试说明文档

## 测试框架

- **JUnit 4**: 单元测试框架
- **PowerMock**: Mock框架，支持Mock静态方法、私有方法等
- **Mockito**: Mock框架，用于Mock对象和方法

## 依赖配置

已在 `pom.xml` 中添加以下测试依赖：

```xml
<!-- JUnit 4 -->
<dependency>
    <groupId>junit</groupId>
    <artifactId>junit</artifactId>
    <version>4.13.2</version>
    <scope>test</scope>
</dependency>

<!-- PowerMock -->
<dependency>
    <groupId>org.powermock</groupId>
    <artifactId>powermock-module-junit4</artifactId>
    <version>2.0.9</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.powermock</groupId>
    <artifactId>powermock-api-mockito2</artifactId>
    <version>2.0.9</version>
    <scope>test</scope>
</dependency>

<!-- Mockito -->
<dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-core</artifactId>
    <version>3.12.4</version>
    <scope>test</scope>
</dependency>
```

## 测试类结构

### 1. 测试类命名规范
- 测试类名：`被测试类名 + Test`
- 例如：`AuthServiceImpl` → `AuthServiceImplTest`

### 2. 测试方法命名规范
- 测试方法名：`test + 方法名 + 场景描述`
- 例如：`testLoginSuccess`, `testLoginUserNotFound`

### 3. 测试类注解
```java
@RunWith(PowerMockRunner.class)  // 使用PowerMock运行器
@PrepareForTest({ClassName.class})  // 准备Mock静态方法的类
```

## 已创建的测试类

### 1. AuthServiceImplTest
- **位置**: `src/test/java/com/aicommunity/service/impl/AuthServiceImplTest.java`
- **测试内容**:
  - 测试登录成功
  - 测试登录失败（用户不存在）
  - 测试登录失败（密码错误）
  - 测试登出

### 2. UserServiceImplTest
- **位置**: `src/test/java/com/aicommunity/service/impl/UserServiceImplTest.java`
- **测试内容**:
  - 测试获取当前用户信息
  - 测试获取当前用户信息（未授权）
  - 测试计算用户积分
  - 测试获取用户个人资料
  - 测试更新用户资料
  - 测试获取用户发布的帖子
  - 测试获取热门贡献者

### 3. PostServiceImplTest
- **位置**: `src/test/java/com/aicommunity/service/impl/PostServiceImplTest.java`
- **测试内容**:
  - 测试获取帖子列表
  - 测试获取帖子详情
  - 测试创建帖子
  - 测试点赞帖子
  - 测试取消点赞帖子
  - 测试删除帖子
  - 测试删除帖子（无权限）

### 4. JwtUtilTest
- **位置**: `src/test/java/com/aicommunity/util/JwtUtilTest.java`
- **测试内容**:
  - 测试生成Token
  - 测试从Token中获取用户ID
  - 测试从Token中获取Claims
  - 测试验证Token（有效/无效/空）

### 5. AuthControllerTest
- **位置**: `src/test/java/com/aicommunity/controller/AuthControllerTest.java`
- **测试内容**:
  - 测试登录接口
  - 测试登出接口

### 6. 通用类测试
- `ResultTest`: 测试Result通用响应类
- `PageQueryTest`: 测试分页查询参数类
- `PageResultTest`: 测试分页结果类
- `BusinessExceptionTest`: 测试业务异常类

## PowerMock使用示例

### 1. Mock静态方法
```java
@PrepareForTest({DigestUtils.class})
public class AuthServiceImplTest {
    
    @Before
    public void setUp() {
        PowerMockito.mockStatic(DigestUtils.class);
        PowerMockito.when(DigestUtils.md5DigestAsHex(any(byte[].class)))
                .thenReturn("hashed-password");
    }
}
```

### 2. Mock私有字段
```java
@PrepareForTest({JwtUtil.class})
public class JwtUtilTest {
    
    @Before
    public void setUp() {
        jwtUtil = new JwtUtil();
        // 使用反射设置私有字段
        Whitebox.setInternalState(jwtUtil, "secret", secret);
        Whitebox.setInternalState(jwtUtil, "expiration", expiration);
    }
}
```

### 3. Mock PageHelper静态方法
```java
@PrepareForTest({PageHelper.class})
public class UserServiceImplTest {
    
    @Before
    public void setUp() {
        PowerMockito.mockStatic(PageHelper.class);
    }
}
```

## Mockito使用示例

### 1. Mock依赖对象
```java
@Mock
private UserMapper userMapper;

@InjectMocks
private AuthServiceImpl authService;

@Before
public void setUp() {
    MockitoAnnotations.initMocks(this);
}
```

### 2. 设置Mock行为
```java
// 当调用方法时返回指定值
when(userMapper.selectByEmployeeId("E001")).thenReturn(testUser);

// 当调用方法时不执行任何操作
doNothing().when(authService).logout();

// 验证方法调用
verify(userMapper, times(1)).selectByEmployeeId("E001");
```

### 3. 参数匹配
```java
// 匹配任何参数
when(userMapper.selectById(anyLong())).thenReturn(testUser);

// 匹配特定参数
when(userMapper.selectById(eq(1L))).thenReturn(testUser);

// 匹配集合参数
when(postTagMapper.insertBatch(anyList())).thenReturn(1);
```

## 运行测试

### 使用Maven运行
```bash
# 运行所有测试
mvn test

# 运行指定测试类
mvn test -Dtest=AuthServiceImplTest

# 运行指定测试方法
mvn test -Dtest=AuthServiceImplTest#testLoginSuccess
```

### 使用IDE运行
- **IntelliJ IDEA**: 右键测试类或测试方法 → Run
- **Eclipse**: 右键测试类或测试方法 → Run As → JUnit Test

## 测试覆盖率

建议使用JaCoCo等工具生成测试覆盖率报告：

```xml
<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <version>0.8.7</version>
    <executions>
        <execution>
            <goals>
                <goal>prepare-agent</goal>
            </goals>
        </execution>
        <execution>
            <id>report</id>
            <phase>test</phase>
            <goals>
                <goal>report</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

## 测试最佳实践

### 1. 测试结构（AAA模式）
```java
@Test
public void testMethodName() {
    // Arrange (Given) - 准备测试数据
    when(mock.method()).thenReturn(value);
    
    // Act (When) - 执行被测试方法
    Result result = service.method();
    
    // Assert (Then) - 验证结果
    assertNotNull(result);
    assertEquals(expected, result.getValue());
}
```

### 2. 测试命名
- 使用描述性的测试方法名
- 格式：`test + 方法名 + 场景描述`
- 例如：`testLoginSuccess`, `testLoginUserNotFound`

### 3. 测试独立性
- 每个测试方法应该独立运行
- 不依赖其他测试的执行顺序
- 使用 `@Before` 和 `@After` 进行初始化和清理

### 4. Mock原则
- 只Mock外部依赖（数据库、外部服务等）
- 不Mock被测试的类本身
- 使用 `@InjectMocks` 注入被测试对象

### 5. 断言
- 使用具体的断言方法（`assertEquals`, `assertNotNull`等）
- 提供清晰的错误消息
- 验证所有重要的返回值

## 扩展测试

### 需要补充的测试类

1. **Service层测试**
   - `CommentServiceImplTest` - 评论服务测试
   - `ActivityServiceImplTest` - 活动服务测试
   - `MessageServiceImplTest` - 消息服务测试
   - `HonorServiceImplTest` - 荣誉服务测试
   - `AdminServiceImplTest` - 管理后台服务测试

2. **Controller层测试**
   - `PostControllerTest` - 帖子控制器测试
   - `UserControllerTest` - 用户控制器测试
   - `CommentControllerTest` - 评论控制器测试
   - `ActivityControllerTest` - 活动控制器测试

3. **工具类测试**
   - `JwtUtilTest` - 已创建
   - 其他工具类测试

4. **Mapper层测试**
   - 使用MyBatis Test或集成测试

## 注意事项

1. **静态方法Mock**: 使用PowerMock的 `@PrepareForTest` 注解
2. **私有字段设置**: 使用 `Whitebox.setInternalState()`
3. **Spring上下文**: 单元测试不加载Spring上下文，需要手动Mock所有依赖
4. **数据库操作**: 使用内存数据库（H2）或Mock Mapper
5. **异常测试**: 使用 `@Test(expected = ExceptionClass.class)`

## 测试配置文件

已创建 `application-test.yml` 用于测试环境配置：
- 使用H2内存数据库
- 简化的配置
- 测试专用的JWT密钥

---

**创建时间**: 2024-01-09
**测试框架**: JUnit 4 + PowerMock + Mockito
