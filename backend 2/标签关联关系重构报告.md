# 标签关联关系重构报告

## 一、重构概述

### 1.1 重构目标
将`t_new_posts`表的`label_id`字段（一对一关系）重构为通过`t_new_posts_tag_relation`关联表实现一对多关系。

### 1.2 数据库变更说明
- **原逻辑**：`t_new_posts.label_id` 一对一对应 `t_new_posts_tag.id`
- **新逻辑**：`t_new_posts`的每条记录通过`t_new_posts_tag_relation`表一对多对应`t_new_posts_tag`的多个`id`
- **关联表结构**：
  - `t_new_posts_tag_relation.post_id` → `t_new_posts.post_id`
  - `t_new_posts_tag_relation.tag_id` → `t_new_posts_tag.id`

## 二、代码修改清单

### 2.1 实体类
1. **创建PostTagRelation实体类**
   - 文件：`backend/src/main/java/com/aicommunity/entity/PostTagRelation.java`
   - 说明：对应`t_new_posts_tag_relation`表结构

### 2.2 Mapper接口修改
1. **PostTagMapper接口**
   - 文件：`backend/src/main/java/com/aicommunity/mapper/PostTagMapper.java`
   - 新增方法：
     - `selectTagsByPostId(String postId)` - 根据帖子ID查询标签列表
     - `insertPostTagRelation(String postId, Integer tagId)` - 插入标签关联关系
     - `deletePostTagRelationByPostId(String postId)` - 删除标签关联关系
     - `selectTagIdByName(String tagName)` - 根据标签名称查询标签ID

### 2.3 Mapper XML文件修改

#### 2.3.1 PostTagMapper.xml
- 修改`selectPostTagRelation`：使用正确的关联表字段映射
- 新增`selectTagsByPostId`：通过关联表查询标签
- 新增`insertPostTagRelation`：插入关联关系
- 新增`deletePostTagRelationByPostId`：逻辑删除关联关系
- 新增`selectTagIdByName`：根据标签名称查询ID

#### 2.3.2 PracticeMapper.xml
- 修改`selectPracticePosts`：标签筛选改为使用关联表
- 修改`countPracticePosts`：标签筛选改为使用关联表
- 修改`selectDepartmentRankings`：标签筛选改为使用关联表
- 修改`selectTagsByPostId`：改为通过关联表查询
- `selectTagsWithCount`：已使用关联表，无需修改

#### 2.3.3 ToolPostMapper.xml
- 修改`selectToolPosts`：
  - category判断改为使用关联表EXISTS查询
  - 标签筛选改为使用关联表
- 修改`countToolPosts`：标签筛选改为使用关联表
- 修改`selectTagsWithCount`：改为使用关联表JOIN
- 修改`selectDepartmentRankings`：标签筛选改为使用关联表
- 修改`selectTagsByPostId`：改为通过关联表查询

#### 2.3.4 EmpowermentMapper.xml
- 修改`selectEmpowermentPosts`：标签筛选改为使用关联表
- 修改`countEmpowermentPosts`：标签筛选改为使用关联表
- 修改`selectTagStats`：改为使用关联表JOIN

#### 2.3.5 ZoneTagMapper.xml
- 修改`selectZoneTags`：改为使用关联表JOIN

#### 2.3.6 PostMapper.xml
- 修改`updatePost`：移除`label_id`字段的更新（已废弃）

### 2.4 Service层修改

#### 2.4.1 PostServiceImpl
- 文件：`backend/src/main/java/com/aicommunity/service/impl/PostServiceImpl.java`
- 新增`PostTagMapper`注入
- 实现`createPost`方法中的标签关联关系保存逻辑
- 实现`updatePost`方法中的标签关联关系更新逻辑
- 新增`savePostTagRelations`辅助方法：保存标签关联关系

#### 2.4.2 PracticeServiceImpl
- 文件：`backend/src/main/java/com/aicommunity/service/impl/PracticeServiceImpl.java`
- 移除不必要的`selectPostTagRelation`调用（标签筛选已在SQL中处理）
- 移除`PostTagRelation`导入

#### 2.4.3 HomeServiceImpl
- 文件：`backend/src/main/java/com/aicommunity/service/impl/HomeServiceImpl.java`
- 修改标签查询逻辑：从`selectByLabelId`改为`selectTagsByPostId`
- 修改标签分类逻辑：从使用`label_id`改为使用关联表查询

## 三、SQL查询变更示例

### 3.1 标签筛选查询（原逻辑）
```sql
-- 原逻辑：使用label_id
WHERE EXISTS (
    SELECT 1 FROM t_new_posts_tag pt
    WHERE pt.id = p.label_id
      AND pt.tag = #{tag}
      AND (pt.deleted IS NULL OR pt.deleted = 0)
)
```

### 3.2 标签筛选查询（新逻辑）
```sql
-- 新逻辑：使用关联表
WHERE EXISTS (
    SELECT 1 FROM t_new_posts_tag_relation ptr
    INNER JOIN t_new_posts_tag pt ON pt.id = ptr.tag_id
    WHERE ptr.post_id = p.post_id
      AND pt.tag = #{tag}
      AND (ptr.deleted IS NULL OR ptr.deleted = 0)
      AND (pt.deleted IS NULL OR pt.deleted = 0)
)
```

### 3.3 根据帖子ID查询标签（原逻辑）
```sql
-- 原逻辑：使用label_id
SELECT pt.*
FROM t_new_posts_tag pt
INNER JOIN t_new_posts p ON pt.label_id = p.label_id
WHERE p.post_id = #{postId}
```

### 3.4 根据帖子ID查询标签（新逻辑）
```sql
-- 新逻辑：使用关联表
SELECT pt.*
FROM t_new_posts_tag pt
INNER JOIN t_new_posts_tag_relation ptr ON pt.id = ptr.tag_id
WHERE ptr.post_id = #{postId}
  AND (ptr.deleted IS NULL OR ptr.deleted = 0)
  AND (pt.deleted IS NULL OR pt.deleted = 0)
```

## 四、注意事项

1. **数据库字段保留**：`t_new_posts.label_id`字段在数据库中仍然保留（标记为废弃），但代码中不再使用该字段进行查询和更新。

2. **兼容性处理**：
   - `PostTagMapper.selectByLabelId`方法保留，用于兼容性（如有需要）
   - `Post`实体类中的`labelId`字段保留，但不参与业务逻辑

3. **标签管理**：
   - 创建帖子时：通过`savePostTagRelations`方法保存标签关联关系
   - 更新帖子时：先删除旧的关联关系，再插入新的关联关系
   - 标签名称到ID的映射：通过`selectTagIdByName`方法实现

4. **性能考虑**：
   - 所有关联查询都添加了`deleted`字段的过滤条件
   - 使用EXISTS子查询进行标签筛选，避免不必要的JOIN

## 五、测试建议

1. **功能测试**：
   - 创建帖子时设置多个标签，验证关联关系正确保存
   - 更新帖子时修改标签，验证关联关系正确更新
   - 查询帖子列表时按标签筛选，验证筛选结果正确
   - 查询帖子详情时，验证标签列表正确显示

2. **边界测试**：
   - 帖子没有标签的情况
   - 帖子有多个标签的情况
   - 标签不存在的情况
   - 删除标签后关联关系的处理

3. **性能测试**：
   - 大量帖子数据下的标签查询性能
   - 标签筛选查询的性能

## 六、修改文件清单

### 6.1 新增文件
- `backend/src/main/java/com/aicommunity/entity/PostTagRelation.java`

### 6.2 修改文件
- `backend/src/main/java/com/aicommunity/mapper/PostTagMapper.java`
- `backend/src/main/resources/mapper/PostTagMapper.xml`
- `backend/src/main/resources/mapper/PracticeMapper.xml`
- `backend/src/main/resources/mapper/ToolPostMapper.xml`
- `backend/src/main/resources/mapper/EmpowermentMapper.xml`
- `backend/src/main/resources/mapper/ZoneTagMapper.xml`
- `backend/src/main/resources/mapper/PostMapper.xml`
- `backend/src/main/java/com/aicommunity/service/impl/PostServiceImpl.java`
- `backend/src/main/java/com/aicommunity/service/impl/PracticeServiceImpl.java`
- `backend/src/main/java/com/aicommunity/service/impl/HomeServiceImpl.java`

## 七、总结

本次重构成功将帖子与标签的一对一关系改为一对多关系，所有涉及`label_id`的查询逻辑都已改为使用`t_new_posts_tag_relation`关联表。代码修改遵循了以下原则：

1. **不修改前端代码**：所有修改仅在后端进行
2. **保持接口兼容**：前端接口调用方式不变
3. **数据完整性**：所有查询都考虑了`deleted`字段的过滤
4. **代码规范**：遵循阿里巴巴Java开发手册规范

重构完成后，系统支持一个帖子关联多个标签，满足了业务需求。
