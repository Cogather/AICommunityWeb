<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicommunity.mapper.MessageMapper">

    <resultMap id="BaseResultMap" type="com.aicommunity.entity.Message">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="user_id" property="userId" jdbcType="VARCHAR"/>
        <result column="type" property="type" jdbcType="VARCHAR"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="LONGVARCHAR"/>
        <result column="related_id" property="relatedId" jdbcType="VARCHAR"/>
        <result column="related_type" property="relatedType" jdbcType="VARCHAR"/>
        <result column="comment_id" property="commentId" jdbcType="INTEGER"/>
        <result column="reply_id" property="replyId" jdbcType="INTEGER"/>
        <result column="from_user_id" property="fromUserId" jdbcType="VARCHAR"/>
        <result column="from_user_name" property="fromUserName" jdbcType="VARCHAR"/>
        <result column="is_read" property="isRead" jdbcType="TINYINT"/>
        <result column="link" property="link" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 分页查询用户消息列表 -->
    <select id="selectMessagesByUserId" resultMap="BaseResultMap">
        SELECT 
            id,
            user_id,
            type,
            title,
            content,
            related_id,
            related_type,
            comment_id,
            reply_id,
            from_user_id,
            from_user_name,
            is_read,
            link,
            create_time,
            update_time
        FROM t_user_messages
        WHERE user_id = #{userId}
        <if test="type != null and type != ''">
            AND type = #{type}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计用户消息总数 -->
    <select id="countMessagesByUserId" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM t_user_messages
        WHERE user_id = #{userId}
        <if test="type != null and type != ''">
            AND type = #{type}
        </if>
    </select>

    <!-- 统计用户未读消息数量 -->
    <select id="countUnreadMessages" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM t_user_messages
        WHERE user_id = #{userId}
          AND is_read = 0
    </select>

    <!-- 根据ID查询消息 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT 
            id,
            user_id,
            type,
            title,
            content,
            related_id,
            related_type,
            comment_id,
            reply_id,
            from_user_id,
            from_user_name,
            is_read,
            link,
            create_time,
            update_time
        FROM t_user_messages
        WHERE id = #{id}
    </select>

    <!-- 插入消息 -->
    <insert id="insertMessage" parameterType="com.aicommunity.entity.Message" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_user_messages (
            user_id,
            type,
            title,
            content,
            related_id,
            related_type,
            comment_id,
            reply_id,
            from_user_id,
            from_user_name,
            is_read,
            link,
            create_time,
            update_time
        ) VALUES (
            #{userId},
            #{type},
            #{title},
            #{content},
            #{relatedId},
            #{relatedType},
            #{commentId},
            #{replyId},
            #{fromUserId},
            #{fromUserName},
            #{isRead},
            #{link},
            #{createTime},
            #{updateTime}
        )
    </insert>

    <!-- 标记消息为已读 -->
    <update id="markAsRead">
        UPDATE t_user_messages
        SET is_read = 1,
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 标记用户所有消息为已读 -->
    <update id="markAllAsRead">
        UPDATE t_user_messages
        SET is_read = 1,
            update_time = NOW()
        WHERE user_id = #{userId}
          AND is_read = 0
    </update>

    <!-- 删除消息 -->
    <delete id="deleteMessage">
        DELETE FROM t_user_messages
        WHERE id = #{id}
    </delete>

</mapper>
