<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicommunity.mapper.UserPointsMapper">

    <select id="selectUserPoints" resultType="java.lang.Integer">
        SELECT COALESCE(total_points, 0) FROM t_user_points
        WHERE user_id = #{userId}
    </select>

    <!-- 查询用户积分历史记录（分页） -->
    <select id="selectPointsHistory" resultType="com.aicommunity.vo.PointsHistoryVO">
        SELECT 
            pt.transaction_id AS id,
            pr.activity_type AS type,
            pr.score_change AS points,
            CONCAT(
                CASE pr.activity_type
                    WHEN 'post_publish' THEN '发布帖子'
                    WHEN 'post_like' THEN '点赞帖子'
                    WHEN 'post_collect' THEN '收藏帖子'
                    WHEN 'comment_publish' THEN '发表评论'
                    WHEN 'activity_join' THEN '参与活动'
                    ELSE pr.activity_type
                END,
                '，获得',
                ABS(pr.score_change),
                '积分'
            ) AS description,
            DATE_FORMAT(pt.timestamp, '%Y-%m-%dT%H:%i:%s') AS createdAt
        FROM t_point_transactions pt
        INNER JOIN t_point_rules pr ON pt.rule_id = pr.rule_id
        WHERE pt.user_id = #{userId}
        ORDER BY pt.timestamp DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计用户积分历史记录总数 -->
    <select id="countPointsHistory" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM t_point_transactions
        WHERE user_id = #{userId}
    </select>

    <!-- 查询积分规则列表 -->
    <select id="selectPointsRules" resultType="com.aicommunity.vo.PointsRuleVO">
        SELECT 
            activity_type AS action,
            score_change AS points,
            CONCAT(
                CASE activity_type
                    WHEN 'post_publish' THEN '发布帖子'
                    WHEN 'post_like' THEN '点赞帖子'
                    WHEN 'post_collect' THEN '收藏帖子'
                    WHEN 'comment_publish' THEN '发表评论'
                    WHEN 'activity_join' THEN '参与活动'
                    ELSE activity_type
                END,
                '，获得',
                ABS(score_change),
                '积分'
            ) AS description
        FROM t_point_rules
        ORDER BY rule_id ASC
    </select>

</mapper>
