<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicommunity.mapper.ToolActivityMapper">

    <!-- 活动实体结果映射 -->
    <resultMap id="ToolActivityResultMap" type="com.aicommunity.entity.ToolActivity">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="toolId" property="toolId" jdbcType="INTEGER"/>
        <result column="toolName" property="toolName" jdbcType="VARCHAR"/>
        <result column="type" property="type" jdbcType="VARCHAR"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="LONGVARCHAR"/>
        <result column="cover" property="cover" jdbcType="VARCHAR"/>
        <result column="date" property="date" jdbcType="DATE"/>
        <result column="startTime" property="startTime" jdbcType="TIME"/>
        <result column="endTime" property="endTime" jdbcType="TIME"/>
        <result column="location" property="location" jdbcType="VARCHAR"/>
        <result column="meetingLink" property="meetingLink" jdbcType="VARCHAR"/>
        <result column="speaker" property="speaker" jdbcType="VARCHAR"/>
        <result column="speakerTitle" property="speakerTitle" jdbcType="VARCHAR"/>
        <result column="maxParticipants" property="maxParticipants" jdbcType="INTEGER"/>
        <result column="currentParticipants" property="currentParticipants" jdbcType="INTEGER"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 活动参与者结果映射 -->
    <resultMap id="ActivityParticipantResultMap" type="com.aicommunity.vo.ActivityParticipantVO">
        <result column="user_id" property="userId" jdbcType="INTEGER"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="employee_id" property="employeeId" jdbcType="VARCHAR"/>
        <result column="department" property="department" jdbcType="VARCHAR"/>
        <result column="avatar" property="avatar" jdbcType="VARCHAR"/>
        <result column="join_time" property="joinTime" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 活动报名结果映射 -->
    <resultMap id="ToolActivityJoinResultMap" type="com.aicommunity.entity.ToolActivityJoin">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="tool_id" property="toolId" jdbcType="INTEGER"/>
        <result column="tool_activity_id" property="toolActivityId" jdbcType="INTEGER"/>
        <result column="join_user_id" property="joinUserId" jdbcType="VARCHAR"/>
        <result column="join_time" property="joinTime" jdbcType="TIMESTAMP"/>
        <result column="canceled" property="canceled" jdbcType="INTEGER"/>
    </resultMap>

    <!-- 查询工具活动列表 -->
    <select id="selectActivities" resultMap="ToolActivityResultMap">
        SELECT 
            id,
            toolId,
            toolName,
            type,
            title,
            content,
            cover,
            date,
            startTime,
            endTime,
            location,
            meetingLink,
            speaker,
            speakerTitle,
            maxParticipants,
            currentParticipants,
            status,
            createTime
        FROM t_new_tool_activity
        WHERE toolId = #{toolId}
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY date DESC, startTime DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计工具活动总数 -->
    <select id="countActivities" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM t_new_tool_activity
        WHERE toolId = #{toolId}
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
    </select>

    <!-- 根据活动ID查询活动详情 -->
    <select id="selectActivityById" resultMap="ToolActivityResultMap">
        SELECT 
            id,
            toolId,
            toolName,
            type,
            title,
            content,
            cover,
            date,
            startTime,
            endTime,
            location,
            meetingLink,
            speaker,
            speakerTitle,
            maxParticipants,
            currentParticipants,
            status,
            createTime
        FROM t_new_tool_activity
        WHERE id = #{activityId}
    </select>

    <!-- 插入活动 -->
    <insert id="insertActivity" parameterType="com.aicommunity.entity.ToolActivity" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_new_tool_activity (
            toolId,
            toolName,
            type,
            title,
            content,
            cover,
            date,
            startTime,
            endTime,
            location,
            meetingLink,
            speaker,
            speakerTitle,
            maxParticipants,
            currentParticipants,
            status,
            createTime
        ) VALUES (
            #{toolId},
            #{toolName},
            #{type},
            #{title},
            #{content},
            #{cover},
            #{date},
            #{startTime},
            #{endTime},
            #{location},
            #{meetingLink},
            #{speaker},
            #{speakerTitle},
            #{maxParticipants},
            #{currentParticipants},
            #{status},
            #{createTime}
        )
    </insert>

    <!-- 更新活动 -->
    <update id="updateActivity" parameterType="com.aicommunity.entity.ToolActivity">
        UPDATE t_new_tool_activity
        <set>
            <if test="toolId != null">toolId = #{toolId},</if>
            <if test="toolName != null">toolName = #{toolName},</if>
            <if test="type != null">type = #{type},</if>
            <if test="title != null">title = #{title},</if>
            <if test="content != null">content = #{content},</if>
            <if test="cover != null">cover = #{cover},</if>
            <if test="date != null">date = #{date},</if>
            <if test="startTime != null">startTime = #{startTime},</if>
            <if test="endTime != null">endTime = #{endTime},</if>
            <if test="location != null">location = #{location},</if>
            <if test="meetingLink != null">meetingLink = #{meetingLink},</if>
            <if test="speaker != null">speaker = #{speaker},</if>
            <if test="speakerTitle != null">speakerTitle = #{speakerTitle},</if>
            <if test="maxParticipants != null">maxParticipants = #{maxParticipants},</if>
            <if test="currentParticipants != null">currentParticipants = #{currentParticipants},</if>
            <if test="status != null">status = #{status},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 查询活动参与者列表（最多返回前10个） -->
    <select id="selectParticipants" resultMap="ActivityParticipantResultMap">
        SELECT 
            CAST(taj.join_user_id AS UNSIGNED) AS user_id,
            COALESCE(ui.chn_name, ui.user_name, taj.join_user_id) AS user_name,
            ui.user_name AS employee_id,
            COALESCE(ui.department_l1, '') AS department,
            COALESCE(ui.author_avatar, '') AS avatar,
            DATE_FORMAT(taj.join_time, '%Y-%m-%dT%H:%i:%sZ') AS join_time
        FROM t_new_tool_activity_join taj
        LEFT JOIN t_user_info ui ON taj.join_user_id = ui.user_id
        WHERE taj.tool_activity_id = #{activityId}
          AND (taj.canceled IS NULL OR taj.canceled = 0)
        ORDER BY taj.join_time ASC
        LIMIT 10
    </select>

    <!-- 查询用户是否已报名活动 -->
    <select id="selectJoinByUser" resultType="com.aicommunity.entity.ToolActivityJoin">
        SELECT 
            id,
            tool_id AS toolId,
            tool_activity_id AS toolActivityId,
            join_user_id AS joinUserId,
            join_time AS joinTime,
            canceled
        FROM t_new_tool_activity_join
        WHERE tool_activity_id = #{activityId}
          AND join_user_id = #{userId}
          AND (canceled IS NULL OR canceled = 0)
        LIMIT 1
    </select>

    <!-- 插入活动报名记录 -->
    <insert id="insertJoin" parameterType="com.aicommunity.entity.ToolActivityJoin" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_new_tool_activity_join (
            tool_id,
            tool_activity_id,
            join_user_id,
            join_time,
            canceled
        ) VALUES (
            #{toolId},
            #{toolActivityId},
            #{joinUserId},
            #{joinTime},
            0
        )
    </insert>

    <!-- 更新活动报名记录（取消报名） -->
    <update id="cancelJoin">
        UPDATE t_new_tool_activity_join
        SET canceled = 1
        WHERE tool_activity_id = #{activityId}
          AND join_user_id = #{userId}
          AND (canceled IS NULL OR canceled = 0)
    </update>

    <!-- 统计活动当前报名人数（未取消的） -->
    <select id="countParticipants" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM t_new_tool_activity_join
        WHERE tool_activity_id = #{activityId}
          AND (canceled IS NULL OR canceled = 0)
    </select>

    <!-- 查询活动报名列表（分页） -->
    <select id="selectRegistrations" resultMap="ActivityParticipantResultMap">
        SELECT 
            CAST(taj.join_user_id AS UNSIGNED) AS user_id,
            COALESCE(ui.chn_name, ui.user_name, taj.join_user_id) AS user_name,
            ui.user_name AS employee_id,
            COALESCE(ui.department_l1, '') AS department,
            COALESCE(ui.author_avatar, '') AS avatar,
            DATE_FORMAT(taj.join_time, '%Y-%m-%dT%H:%i:%sZ') AS join_time
        FROM t_new_tool_activity_join taj
        LEFT JOIN t_user_info ui ON taj.join_user_id = ui.user_id
        WHERE taj.tool_activity_id = #{activityId}
          AND (taj.canceled IS NULL OR taj.canceled = 0)
        ORDER BY taj.join_time ASC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计活动报名总数（未取消的） -->
    <select id="countRegistrations" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM t_new_tool_activity_join
        WHERE tool_activity_id = #{activityId}
          AND (canceled IS NULL OR canceled = 0)
    </select>

    <!-- 删除活动 -->
    <delete id="deleteActivity">
        DELETE FROM t_new_tool_activity
        WHERE id = #{activityId}
    </delete>

    <!-- 删除活动报名记录（删除活动时调用） -->
    <delete id="deleteJoinsByActivity">
        DELETE FROM t_new_tool_activity_join
        WHERE tool_activity_id = #{activityId}
    </delete>

    <!-- 查询用户参与的活动列表（分页） -->
    <select id="selectUserJoinedActivities" resultMap="ToolActivityResultMap">
        SELECT 
            ta.id,
            ta.toolId,
            ta.toolName,
            ta.type,
            ta.title,
            ta.content,
            ta.cover,
            ta.date,
            ta.startTime,
            ta.endTime,
            ta.location,
            ta.meetingLink,
            ta.speaker,
            ta.speakerTitle,
            ta.maxParticipants,
            ta.currentParticipants,
            ta.status,
            ta.createTime
        FROM t_new_tool_activity ta
        INNER JOIN t_new_tool_activity_join taj ON ta.id = taj.tool_activity_id
        WHERE taj.join_user_id = #{userId}
          AND taj.canceled = 0
          AND ta.status != 'deleted'
        ORDER BY taj.join_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计用户参与的活动总数 -->
    <select id="countUserJoinedActivities" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM t_new_tool_activity ta
        INNER JOIN t_new_tool_activity_join taj ON ta.id = taj.tool_activity_id
        WHERE taj.join_user_id = #{userId}
          AND taj.canceled = 0
          AND ta.status != 'deleted'
    </select>

    <!-- 查询用户创建的活动列表（分页）
         注意：由于数据库表中没有create_user_id字段，这里通过工具Owner关系来查询
         用户创建的活动 = 用户拥有的工具下的所有活动
    -->
    <select id="selectUserCreatedActivities" resultMap="ToolActivityResultMap">
        SELECT 
            ta.id,
            ta.toolId,
            ta.toolName,
            ta.type,
            ta.title,
            ta.content,
            ta.cover,
            ta.date,
            ta.startTime,
            ta.endTime,
            ta.location,
            ta.meetingLink,
            ta.speaker,
            ta.speakerTitle,
            ta.maxParticipants,
            ta.currentParticipants,
            ta.status,
            ta.createTime
        FROM t_new_tool_activity ta
        INNER JOIN t_new_tool t ON ta.toolId = t.tool_id
        WHERE t.owner = #{userId}
          AND ta.status != 'deleted'
        ORDER BY ta.createTime DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计用户创建的活动总数 -->
    <select id="countUserCreatedActivities" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM t_new_tool_activity ta
        INNER JOIN t_new_tool t ON ta.toolId = t.tool_id
        WHERE t.owner = #{userId}
          AND ta.status != 'deleted'
    </select>

</mapper>
