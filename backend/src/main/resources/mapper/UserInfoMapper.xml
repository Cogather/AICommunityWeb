<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicommunity.mapper.UserInfoMapper">

    <resultMap id="BaseResultMap" type="com.aicommunity.entity.UserInfo">
        <id column="user_id" property="userId" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="chn_name" property="chnName" jdbcType="VARCHAR"/>
        <result column="author_avatar" property="authorAvatar" jdbcType="VARCHAR"/>
        <result column="bio" property="bio" jdbcType="VARCHAR"/>
        <result column="department_l1" property="departmentL1" jdbcType="VARCHAR"/>
        <result column="department_l1_id" property="departmentL1Id" jdbcType="VARCHAR"/>
        <result column="department_l2" property="departmentL2" jdbcType="VARCHAR"/>
        <result column="department_l2_id" property="departmentL2Id" jdbcType="VARCHAR"/>
        <result column="department_l3" property="departmentL3" jdbcType="VARCHAR"/>
        <result column="department_l3_id" property="departmentL3Id" jdbcType="VARCHAR"/>
        <result column="department_l4" property="departmentL4" jdbcType="VARCHAR"/>
        <result column="department_l4_id" property="departmentL4Id" jdbcType="VARCHAR"/>
        <result column="department_l5" property="departmentL5" jdbcType="VARCHAR"/>
        <result column="department_l5_id" property="departmentL5Id" jdbcType="VARCHAR"/>
        <result column="department_l6" property="departmentL6" jdbcType="VARCHAR"/>
        <result column="department_l6_id" property="departmentL6Id" jdbcType="VARCHAR"/>
        <result column="role" property="role" jdbcType="VARCHAR"/>
        <result column="level" property="level" jdbcType="INTEGER"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT 
            user_id,
            user_name,
            chn_name,
            author_avatar,
            bio,
            department_l1,
            department_l1_id,
            department_l2,
            department_l2_id,
            department_l3,
            department_l3_id,
            department_l4,
            department_l4_id,
            department_l5,
            department_l5_id,
            department_l6,
            department_l6_id,
            role,
            level,
            status,
            updated_at
        FROM t_user_info
        WHERE user_id = #{userId}
    </select>

    <select id="selectByUserName" resultMap="BaseResultMap">
        SELECT 
            user_id,
            user_name,
            chn_name,
            author_avatar,
            bio,
            department_l1,
            department_l1_id,
            department_l2,
            department_l2_id,
            department_l3,
            department_l3_id,
            department_l4,
            department_l4_id,
            department_l5,
            department_l5_id,
            department_l6,
            department_l6_id,
            role,
            level,
            status,
            updated_at
        FROM t_user_info
        WHERE user_name = #{userName}
    </select>

    <update id="updateUserProfile">
        UPDATE t_user_info
        <set>
            <if test="avatar != null">
                author_avatar = #{avatar},
            </if>
            <if test="bio != null">
                bio = #{bio},
            </if>
            updated_at = NOW()
        </set>
        WHERE user_id = #{userId}
    </update>

    <select id="countUserPosts" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_new_posts
        WHERE author_id = #{userId} AND status = '0'
    </select>

    <select id="countUserFavorites" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_new_post_collected
        WHERE collected_user_id = #{userId}
    </select>

    <select id="countUserComments" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_new_post_comments
        WHERE user_id = #{userId} AND status = '0'
    </select>

    <select id="countUserActivities" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_new_tool_activity_join
        WHERE join_user_id = #{userId} AND canceled = 0
    </select>

    <select id="countUserFlowers" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_new_honors_flowers
        WHERE flowers_user_id = #{userId}
    </select>

    <select id="selectUsers" resultMap="BaseResultMap">
        SELECT 
            user_id,
            user_name,
            chn_name,
            author_avatar,
            bio,
            department_l1,
            department_l1_id,
            department_l2,
            department_l2_id,
            department_l3,
            department_l3_id,
            department_l4,
            department_l4_id,
            department_l5,
            department_l5_id,
            department_l6,
            department_l6_id,
            role,
            level,
            status,
            updated_at
        FROM t_user_info
        <where>
            status = '0'
            <if test="keyword != null and keyword != ''">
                AND (chn_name LIKE CONCAT('%', #{keyword}, '%')
                     OR user_name LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="role != null and role != ''">
                AND role LIKE CONCAT('%', #{role}, '%')
            </if>
        </where>
        ORDER BY updated_at DESC
    </select>

    <select id="selectByUserIdInt" resultMap="BaseResultMap">
        SELECT 
            user_id,
            user_name,
            chn_name,
            author_avatar,
            bio,
            department_l1,
            department_l1_id,
            department_l2,
            department_l2_id,
            department_l3,
            department_l3_id,
            department_l4,
            department_l4_id,
            department_l5,
            department_l5_id,
            department_l6,
            department_l6_id,
            role,
            level,
            status,
            updated_at
        FROM t_user_info
        WHERE user_id = CAST(#{userId} AS CHAR)
           OR user_id = #{userId}
        LIMIT 1
    </select>

    <update id="updateUserRole">
        UPDATE t_user_info
        SET role = #{role},
            updated_at = NOW()
        WHERE user_id = #{userId}
    </update>

</mapper>
