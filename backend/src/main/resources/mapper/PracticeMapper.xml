<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicommunity.mapper.PracticeMapper">

    <!-- 帖子项结果映射 -->
    <resultMap id="PostItemResultMap" type="com.aicommunity.vo.PostItemVO">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="author" property="author" jdbcType="VARCHAR"/>
        <result column="author_id" property="authorId" jdbcType="INTEGER"/>
        <result column="author_avatar" property="authorAvatar" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="VARCHAR"/>
        <result column="create_time_display" property="createTimeDisplay" jdbcType="VARCHAR"/>
        <result column="views" property="views" jdbcType="INTEGER"/>
        <result column="comments" property="comments" jdbcType="INTEGER"/>
        <result column="likes" property="likes" jdbcType="INTEGER"/>
        <result column="image" property="image" jdbcType="VARCHAR"/>
        <result column="featured" property="featured" jdbcType="BOOLEAN"/>
        <result column="department" property="department" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 最热帖子结果映射 -->
    <resultMap id="HotPostResultMap" type="com.aicommunity.vo.HotPostVO">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="views" property="views" jdbcType="INTEGER"/>
        <result column="rank" property="rank" jdbcType="INTEGER"/>
    </resultMap>

    <!-- 标签结果映射 -->
    <resultMap id="TagResultMap" type="com.aicommunity.vo.TagVO">
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="count" property="count" jdbcType="INTEGER"/>
    </resultMap>

    <!-- 部门结果映射 -->
    <resultMap id="DepartmentResultMap" type="com.aicommunity.vo.DepartmentVO">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="post_count" property="postCount" jdbcType="INTEGER"/>
        <result column="contributor_count" property="contributorCount" jdbcType="INTEGER"/>
    </resultMap>

    <!-- 贡献者结果映射 -->
    <resultMap id="ContributorResultMap" type="com.aicommunity.vo.ContributorVO">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="avatar" property="avatar" jdbcType="VARCHAR"/>
        <result column="post_count" property="postCount" jdbcType="INTEGER"/>
        <result column="department" property="department" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 用户信息结果映射 -->
    <resultMap id="UserInfoResultMap" type="com.aicommunity.entity.UserInfo">
        <id column="user_id" property="userId" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="chn_name" property="chnName" jdbcType="VARCHAR"/>
        <result column="department_l1" property="departmentL1" jdbcType="VARCHAR"/>
        <result column="department_l1_id" property="departmentL1Id" jdbcType="VARCHAR"/>
        <result column="department_l2" property="departmentL2" jdbcType="VARCHAR"/>
        <result column="department_l2_id" property="departmentL2Id" jdbcType="VARCHAR"/>
        <result column="department_l3" property="departmentL3" jdbcType="VARCHAR"/>
        <result column="department_l3_id" property="departmentL3Id" jdbcType="VARCHAR"/>
        <result column="department_l4" property="departmentL4" jdbcType="VARCHAR"/>
        <result column="department_l4_id" property="departmentL4Id" jdbcType="VARCHAR"/>
        <result column="department_l5" property="departmentL5" jdbcType="VARCHAR"/>
        <result column="department_l5_id" property="departmentL5Id" jdbcType="VARCHAR"/>
        <result column="department_l6" property="departmentL6" jdbcType="VARCHAR"/>
        <result column="department_l6_id" property="departmentL6Id" jdbcType="VARCHAR"/>
        <result column="role" property="role" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 标签实体结果映射 -->
    <resultMap id="PostTagResultMap" type="com.aicommunity.entity.PostTag">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="label_id" property="labelId" jdbcType="INTEGER"/>
        <result column="tag" property="tag" jdbcType="VARCHAR"/>
        <result column="color" property="color" jdbcType="VARCHAR"/>
        <result column="bg" property="bg" jdbcType="VARCHAR"/>
        <result column="border_color" property="borderColor" jdbcType="VARCHAR"/>
        <result column="deleted" property="deleted" jdbcType="BOOLEAN"/>
        <result column="user_id" property="userId" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 查询AI优秀实践帖子列表 -->
    <select id="selectPracticePosts" resultMap="PostItemResultMap">
        SELECT 
            CAST(p.post_id AS UNSIGNED) AS id,
            p.title,
            SUBSTRING(p.content, 1, 200) AS description,
            COALESCE(ui.chn_name, p.author_id) AS author,
            CAST(p.author_id AS UNSIGNED) AS author_id,
            COALESCE(ui.author_avatar, '') AS author_avatar,
            DATE_FORMAT(p.created_at, '%Y-%m-%dT%H:%i:%sZ') AS create_time,
            DATE_FORMAT(p.created_at, '%Y年%m月%d日') AS create_time_display,
            COALESCE(p.views_nums, 0) AS views,
            COALESCE(comment_stats.comment_count, 0) AS comments,
            COALESCE(like_stats.like_count, 0) AS likes,
            p.front_cover AS image,
            CASE WHEN p.essence_post = '1' THEN TRUE ELSE FALSE END AS featured,
            COALESCE(ui.department_l1, '') AS department
        FROM t_new_posts p
        LEFT JOIN t_user_info ui ON p.author_id = ui.user_id
        LEFT JOIN (
            SELECT post_id, COUNT(*) AS comment_count
            FROM t_new_post_comments
            WHERE status = '0'
            GROUP BY post_id
        ) comment_stats ON p.post_id = comment_stats.post_id
        LEFT JOIN (
            SELECT post_id, COUNT(*) AS like_count
            FROM t_new_post_likes
            GROUP BY post_id
        ) like_stats ON p.post_id = like_stats.post_id
        WHERE p.zone_id = 1
          AND p.status = '0'
        <if test="keyword != null and keyword != ''">
          AND (p.title LIKE CONCAT('%', #{keyword}, '%')
               OR p.content LIKE CONCAT('%', #{keyword}, '%')
               OR ui.chn_name LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="tag != null and tag != ''">
          AND EXISTS (
              SELECT 1 FROM t_new_posts_tag pt
              WHERE pt.label_id = p.label_id
                AND pt.tag = #{tag}
                AND (pt.deleted IS NULL OR pt.deleted = 0)
          )
        </if>
        <if test="department != null and department != ''">
          AND ui.department_l1 = #{department}
        </if>
        <if test="contributor != null and contributor != ''">
          AND ui.chn_name = #{contributor}
        </if>
        <choose>
            <when test="sortBy == 'hot'">
                ORDER BY p.views_nums DESC, p.created_at DESC
            </when>
            <when test="sortBy == 'comments'">
                ORDER BY COALESCE(comment_stats.comment_count, 0) DESC, p.created_at DESC
            </when>
            <when test="sortBy == 'likes'">
                ORDER BY COALESCE(like_stats.like_count, 0) DESC, p.created_at DESC
            </when>
            <otherwise>
                ORDER BY p.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计AI优秀实践帖子总数 -->
    <select id="countPracticePosts" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT p.post_id)
        FROM t_new_posts p
        LEFT JOIN t_user_info ui ON p.author_id = ui.user_id
        WHERE p.zone_id = 1
          AND p.status = '0'
        <if test="keyword != null and keyword != ''">
          AND (p.title LIKE CONCAT('%', #{keyword}, '%')
               OR p.content LIKE CONCAT('%', #{keyword}, '%')
               OR ui.chn_name LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="tag != null and tag != ''">
          AND EXISTS (
              SELECT 1 FROM t_new_posts_tag pt
              WHERE pt.label_id = p.label_id
                AND pt.tag = #{tag}
                AND (pt.deleted IS NULL OR pt.deleted = 0)
          )
        </if>
        <if test="department != null and department != ''">
          AND ui.department_l1 = #{department}
        </if>
        <if test="contributor != null and contributor != ''">
          AND ui.chn_name = #{contributor}
        </if>
    </select>

    <!-- 查询最热帖子Top N -->
    <select id="selectHotPosts" resultMap="HotPostResultMap">
        SELECT 
            CAST(p.post_id AS UNSIGNED) AS id,
            p.title,
            COALESCE(p.views_nums, 0) AS views,
            0 AS rank
        FROM t_new_posts p
        WHERE p.zone_id = 1
          AND p.status = '0'
        ORDER BY p.views_nums DESC, p.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 查询标签列表及统计数量 -->
    <select id="selectTagsWithCount" resultMap="TagResultMap">
        SELECT 
            pt.tag AS name,
            COUNT(DISTINCT p.post_id) AS count
        FROM t_new_posts p
        INNER JOIN t_new_posts_tag pt ON pt.label_id = p.label_id AND (pt.deleted IS NULL OR pt.deleted = 0)
        LEFT JOIN t_user_info ui ON p.author_id = ui.user_id
        WHERE p.zone_id = 1
          AND p.status = '0'
        <if test="department != null and department != ''">
          AND ui.department_l1 = #{department}
        </if>
        GROUP BY pt.tag
        ORDER BY count DESC, name ASC
    </select>

    <!-- 查询部门排名列表 -->
    <select id="selectDepartmentRankings" resultMap="DepartmentResultMap">
        SELECT 
            COALESCE(ui.department_l1, '未知部门') AS name,
            COUNT(DISTINCT p.post_id) AS post_count,
            COUNT(DISTINCT p.author_id) AS contributor_count
        FROM t_new_posts p
        LEFT JOIN t_user_info ui ON p.author_id = ui.user_id
        WHERE p.zone_id = 1
          AND p.status = '0'
        <if test="tag != null and tag != ''">
          AND EXISTS (
              SELECT 1 FROM t_new_posts_tag pt
              WHERE pt.label_id = p.label_id
                AND pt.tag = #{tag}
                AND (pt.deleted IS NULL OR pt.deleted = 0)
          )
        </if>
        GROUP BY ui.department_l1
        HAVING name IS NOT NULL AND name != ''
        ORDER BY post_count DESC
    </select>

    <!-- 查询热门贡献者列表 -->
    <select id="selectTopContributors" resultMap="ContributorResultMap">
        SELECT 
            CAST(p.author_id AS UNSIGNED) AS id,
            COALESCE(ui.chn_name, p.author_id) AS name,
            COALESCE(ui.author_avatar, '') AS avatar,
            COUNT(DISTINCT p.post_id) AS post_count,
            COALESCE(ui.department_l1, '') AS department
        FROM t_new_posts p
        LEFT JOIN t_user_info ui ON p.author_id = ui.user_id
        WHERE p.zone_id = 1
          AND p.status = '0'
        GROUP BY p.author_id, ui.chn_name, ui.department_l1, ui.author_avatar
        ORDER BY post_count DESC
        LIMIT #{limit}
    </select>

    <!-- 根据用户ID查询用户信息 -->
    <select id="selectUserInfoById" resultMap="UserInfoResultMap">
        SELECT 
            user_id,
            user_name,
            chn_name,
            department_l1,
            department_l1_id,
            department_l2,
            department_l2_id,
            department_l3,
            department_l3_id,
            department_l4,
            department_l4_id,
            department_l5,
            department_l5_id,
            department_l6,
            department_l6_id,
            role,
            status,
            updated_at
        FROM t_user_info
        WHERE user_id = #{userId}
    </select>

    <!-- 根据帖子ID查询标签列表 -->
    <select id="selectTagsByPostId" resultMap="PostTagResultMap">
        SELECT 
            pt.id,
            pt.label_id,
            pt.tag,
            pt.color,
            pt.bg,
            pt.border_color,
            pt.deleted,
            pt.user_id
        FROM t_new_posts_tag pt
        INNER JOIN t_new_posts p ON pt.label_id = p.label_id
        WHERE p.post_id = #{postId}
          AND (pt.deleted IS NULL OR pt.deleted = 0)
    </select>

    <!-- 根据标签名称查询标签信息 -->
    <select id="selectTagByName" resultMap="PostTagResultMap">
        SELECT 
            id,
            label_id,
            tag,
            color,
            bg,
            border_color,
            deleted,
            user_id
        FROM t_new_posts_tag
        WHERE tag = #{tagName}
          AND (deleted IS NULL OR deleted = 0)
        LIMIT 1
    </select>

</mapper>
