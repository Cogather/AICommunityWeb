# 用户认证与信息接口文档

## 概述

本文档定义了AI社区Web平台的用户认证与信息相关接口。平台所有用户信息映射都来自统一的用户中心服务，通过工号（employeeId/userId）作为唯一标识。

---

## 接口概览

| 接口 | 说明 | 方法 |
|-----|------|------|
| 用户登录 | 通过工号密码登录获取token | POST |
| 获取当前用户信息 | 获取当前登录用户的完整信息 | GET |
| 根据ID获取用户信息 | 获取指定用户的公开信息 | GET |
| 根据工号获取用户信息 | 通过工号查询用户信息 | GET |
| 更新用户信息 | 更新当前用户的个人信息 | PUT |
| 退出登录 | 用户退出登录 | POST |

---

## 接口列表

### 1. 用户登录

通过工号和密码进行登录认证，获取访问令牌。

**请求**

```
POST /api/auth/login
```

**请求体**

```json
{
  "employeeId": "E001",
  "password": "******"
}
```

**请求字段说明**

| 字段 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| employeeId | string | 是 | 工号 |
| password | string | 是 | 密码 |

**响应**

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 86400,
    "user": {
      "id": 1,
      "employeeId": "E001",
      "name": "张三",
      "avatar": "https://example.com/avatars/user1.jpg",
      "roles": ["user"],
      "departments": {
        "level1": { "id": 100, "name": "技术部", "level": 1 },
        "level2": { "id": 110, "name": "AI研发中心", "level": 2 },
        "level3": { "id": 111, "name": "智能应用组", "level": 3 }
      }
    }
  }
}
```

**响应字段说明**

| 字段 | 类型 | 说明 |
|-----|------|------|
| token | string | JWT访问令牌 |
| expiresIn | number | 令牌有效期（秒） |
| user | object | 用户基本信息 |

---

### 2. 获取当前用户信息

获取当前登录用户的完整信息，包括角色、部门、统计数据等。

**请求**

```
GET /api/user/current
```

**请求头**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| Authorization | string | 是 | Bearer {token} |

**响应**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "employeeId": "E001",
    "name": "张三",
    "avatar": "https://example.com/avatars/user1.jpg",
    "bio": "AI技术爱好者，专注于智能应用开发",
    "department": "技术部/AI研发中心/智能应用组",
    "departments": {
      "level1": {
        "id": 100,
        "name": "技术部",
        "level": 1
      },
      "level2": {
        "id": 110,
        "name": "AI研发中心",
        "level": 2
      },
      "level3": {
        "id": 111,
        "name": "智能应用组",
        "level": 3
      },
      "level4": null,
      "level5": null,
      "level6": null
    },
    "roles": ["admin", "user", "tool_owner"],
    "ownedTools": [
      { "toolId": 1, "toolName": "TestMate" }
    ],
    "postsCount": 15,
    "favoritesCount": 32,
    "commentsCount": 48,
    "activitiesCount": 5,
    "flowersCount": 120,
    "points": 2500
  }
}
```

**响应字段说明**

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | number | 用户ID（系统内部ID） |
| employeeId | string | 工号（用户中心唯一标识） |
| name | string | 姓名 |
| avatar | string | 头像URL |
| bio | string | 个人简介 |
| department | string | 完整部门路径（用/分隔） |
| departments | object | 多级部门详细信息 |
| departments.level1 | object | 一级部门信息 |
| departments.level2 | object | 二级部门信息 |
| departments.level3 | object | 三级部门信息 |
| departments.level4 | object | 四级部门信息（可为null） |
| departments.level5 | object | 五级部门信息（可为null） |
| departments.level6 | object | 六级部门信息（可为null） |
| roles | array | 用户角色列表 |
| ownedTools | array | 作为Owner管理的工具列表 |
| postsCount | number | 发布帖子数 |
| favoritesCount | number | 收藏数 |
| commentsCount | number | 评论数 |
| activitiesCount | number | 参与活动数 |
| flowersCount | number | 获得小红花数 |
| points | number | 积分 |

---

### 3. 根据ID获取用户信息

获取指定用户的公开信息（用于查看他人主页）。

**请求**

```
GET /api/user/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| id | number | 是 | 用户ID |

**响应**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 2,
    "employeeId": "E002",
    "name": "李四",
    "avatar": "https://example.com/avatars/user2.jpg",
    "bio": "数据分析师",
    "department": "数据部/BI中心",
    "departments": {
      "level1": { "id": 200, "name": "数据部", "level": 1 },
      "level2": { "id": 210, "name": "BI中心", "level": 2 }
    },
    "postsCount": 8,
    "favoritesCount": 20,
    "commentsCount": 35,
    "activitiesCount": 3,
    "flowersCount": 85,
    "points": 1800
  }
}
```

> **注意**：查看他人信息时，不返回 `roles` 和 `ownedTools` 等敏感字段。

---

### 4. 根据工号获取用户信息

通过工号查询用户信息（用于管理后台按工号搜索）。

**请求**

```
GET /api/user/by-employee-id/{employeeId}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| employeeId | string | 是 | 工号 |

**响应**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 3,
    "employeeId": "E003",
    "name": "王五",
    "avatar": "https://example.com/avatars/user3.jpg",
    "department": "产品部/用户体验组",
    "departments": {
      "level1": { "id": 300, "name": "产品部", "level": 1 },
      "level2": { "id": 310, "name": "用户体验组", "level": 2 }
    }
  }
}
```

---

### 5. 更新用户信息

更新当前用户的个人信息（头像、简介等）。

**请求**

```
PUT /api/user/current
```

**请求头**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| Authorization | string | 是 | Bearer {token} |

**请求体**

```json
{
  "avatar": "https://example.com/avatars/new-avatar.jpg",
  "bio": "更新后的个人简介"
}
```

**请求字段说明**

| 字段 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| avatar | string | 否 | 新头像URL |
| bio | string | 否 | 新个人简介 |

> **注意**：用户只能修改 `avatar` 和 `bio`，其他信息（姓名、工号、部门等）由用户中心同步，不可修改。

**响应**

```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

---

### 6. 退出登录

用户退出登录，使当前token失效。

**请求**

```
POST /api/auth/logout
```

**请求头**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| Authorization | string | 是 | Bearer {token} |

**响应**

```json
{
  "code": 200,
  "message": "退出成功",
  "data": null
}
```

---

## 数据字典

### 用户角色说明

| 角色 | 值 | 说明 | 权限 |
|-----|-----|------|------|
| 管理员 | admin | 系统管理员 | 所有权限，包括后台管理、配置等 |
| 普通用户 | user | 普通用户 | 浏览、发帖、评论、报名活动等 |
| 工具Owner | tool_owner | 工具负责人 | 发布工具相关活动、管理工具帖子等 |

### 部门层级说明

| 层级 | 字段 | 说明 | 示例 |
|-----|-----|------|------|
| 一级部门 | level1 | 公司一级组织 | 技术部、产品部、数据部 |
| 二级部门 | level2 | 一级部门下的中心/部门 | AI研发中心、BI中心 |
| 三级部门 | level3 | 二级部门下的组/室 | 智能应用组、算法组 |
| 四级部门 | level4 | 三级部门下的小组（可选） | - |
| 五级部门 | level5 | 四级部门下的小组（可选） | - |
| 六级部门 | level6 | 五级部门下的小组（可选） | - |

### 部门信息结构

```typescript
interface DepartmentInfo {
  id: number      // 部门ID
  name: string    // 部门名称
  level: number   // 部门层级（1-6）
}
```

---

## 前端使用示例

### 获取当前用户信息

```typescript
import { getCurrentUser } from '../mock'

const loadCurrentUser = async () => {
  const user = await getCurrentUser()
  
  // 获取用户基本信息
  console.log('工号:', user.employeeId)
  console.log('姓名:', user.name)
  console.log('头像:', user.avatar)
  
  // 获取用户角色
  const isAdmin = user.roles?.includes('admin')
  const isToolOwner = user.roles?.includes('tool_owner')
  
  // 获取部门信息
  const level1Dept = user.departments?.level1?.name  // 一级部门名称
  const level2Dept = user.departments?.level2?.name  // 二级部门名称
  const fullDeptPath = user.department               // 完整部门路径
}
```

### 按工号搜索用户（管理后台）

```typescript
import { getUserByEmployeeId } from '../mock'

const searchUserByEmployeeId = async (employeeId: string) => {
  try {
    const user = await getUserByEmployeeId(employeeId)
    if (user) {
      console.log('找到用户:', user.name)
      console.log('所属部门:', user.department)
    }
  } catch (error) {
    console.error('用户不存在')
  }
}
```

### 权限判断

```typescript
// 判断是否为管理员
const isAdmin = (user: UserProfile): boolean => {
  return user.roles?.includes('admin') || false
}

// 判断是否为工具Owner
const isToolOwner = (user: UserProfile, toolId: number): boolean => {
  return user.ownedTools?.some(t => t.toolId === toolId) || false
}

// 判断是否有发布活动权限
const canPublishActivity = (user: UserProfile, toolId: number): boolean => {
  return isAdmin(user) || isToolOwner(user, toolId)
}
```

---

## 错误码说明

| 错误码 | 说明 |
|-------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未登录或token已过期 |
| 403 | 无权限访问 |
| 404 | 用户不存在 |
| 500 | 服务器内部错误 |

### 登录相关错误

| 错误码 | 说明 |
|-------|------|
| 40001 | 工号不存在 |
| 40002 | 密码错误 |
| 40003 | 账号已被禁用 |
| 40004 | 登录失败次数过多，请稍后重试 |

---

## TypeScript类型定义

```typescript
// 部门信息
export interface DepartmentInfo {
  id: number
  name: string
  level: number
}

// 用户信息
export interface UserProfile {
  id: number
  employeeId?: string
  name: string
  avatar: string
  bio?: string
  department?: string
  departments?: {
    level1?: DepartmentInfo
    level2?: DepartmentInfo
    level3?: DepartmentInfo
    level4?: DepartmentInfo
    level5?: DepartmentInfo
    level6?: DepartmentInfo
  }
  postsCount: number
  favoritesCount: number
  commentsCount: number
  activitiesCount: number
  flowersCount: number
  points: number
  roles?: string[]
  ownedTools?: Array<{
    toolId: number
    toolName: string
  }>
}

// 登录请求参数
export interface LoginParams {
  employeeId: string
  password: string
}

// 登录响应
export interface LoginResponse {
  token: string
  expiresIn: number
  user: UserProfile
}
```

---

## 与用户中心集成说明

### 数据同步机制

1. **用户基本信息**：姓名、工号、部门等信息由公司统一用户中心维护，本平台只读取不修改
2. **头像和简介**：用户可在本平台自定义头像和个人简介
3. **角色权限**：由本平台管理员在后台配置
4. **工具Owner**：由管理员指定，与具体工具关联

### 用户标识映射

| 字段 | 来源 | 说明 |
|-----|------|------|
| id | 本平台 | 系统内部ID，用于关联帖子、评论等 |
| employeeId | 用户中心 | 工号，唯一标识，用于跨系统识别 |

### 部门信息同步

- 部门结构从用户中心自动同步
- 支持最多6级部门层级
- 部门ID用于统计分析和筛选
