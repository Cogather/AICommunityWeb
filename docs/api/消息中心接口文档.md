# 消息中心接口文档

## 概述

消息中心用于管理用户接收的各类通知消息，包括：
- 活动报名通知
- 帖子评论通知
- 评论回复通知
- 点赞通知
- 奖项通知

---

## 接口概览

| 接口 | 说明 | 方法 |
|-----|------|------|
| 获取消息列表 | 获取用户的消息列表 | GET |
| 获取未读消息数量 | 获取未读消息数量 | GET |
| 标记消息已读 | 标记单条消息为已读 | PUT |
| 标记全部已读 | 标记所有消息为已读 | PUT |
| 删除消息 | 删除单条消息 | DELETE |

---

## 接口列表

### 1. 获取消息列表

获取当前登录用户的消息列表（分页）。

**请求**

```
GET /api/messages
```

**请求参数**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| type | string | 否 | 消息类型筛选 |
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页数量，默认15 |

**响应**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "type": "post_comment",
        "title": "帖子评论通知",
        "content": "李四 评论了您的帖子《AI大会2024》",
        "relatedId": 1,
        "relatedType": "post",
        "commentId": 101,
        "fromUserId": 2,
        "fromUserName": "李四",
        "read": false,
        "createdAt": "2026-01-13T10:30:00Z"
      },
      {
        "id": 2,
        "type": "comment_reply",
        "title": "评论回复通知",
        "content": "赵六 回复了您的评论",
        "relatedId": 1,
        "relatedType": "post",
        "commentId": 101,
        "replyId": 1002,
        "fromUserId": 5,
        "fromUserName": "赵六",
        "read": false,
        "createdAt": "2026-01-13T09:00:00Z"
      },
      {
        "id": 3,
        "type": "activity_registration",
        "title": "活动报名通知",
        "content": "李四 报名参加了您发布的活动《扶摇Agent新手入门培训》",
        "relatedId": 1,
        "relatedType": "activity",
        "fromUserId": 3,
        "fromUserName": "李四",
        "read": false,
        "createdAt": "2026-01-13T08:30:00Z"
      },
      {
        "id": 4,
        "type": "post_like",
        "title": "点赞通知",
        "content": "王五 赞了您的帖子《AI大会2024》",
        "relatedId": 1,
        "relatedType": "post",
        "fromUserId": 4,
        "fromUserName": "王五",
        "read": true,
        "createdAt": "2026-01-12T16:00:00Z"
      }
    ],
    "total": 50,
    "page": 1,
    "pageSize": 15
  }
}
```

**响应字段说明**

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | number | 消息ID |
| type | string | 消息类型 |
| title | string | 消息标题 |
| content | string | 消息内容 |
| relatedId | number | 相关资源ID（帖子ID、活动ID等） |
| relatedType | string | 相关资源类型（post、activity、award等） |
| commentId | number | 评论ID（POST_COMMENT和COMMENT_REPLY类型使用，用于定位到具体评论） |
| replyId | number | 回复ID（COMMENT_REPLY类型使用，用于定位到具体回复） |
| fromUserId | number | 发送者用户ID |
| fromUserName | string | 发送者用户名 |
| read | boolean | 是否已读 |
| createdAt | string | 创建时间（ISO 8601格式） |

---

### 2. 获取未读消息数量

获取当前用户的未读消息数量，用于导航栏红点提示。

**请求**

```
GET /api/messages/unread-count
```

**响应**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "count": 5
  }
}
```

---

### 3. 标记消息已读

标记单条消息为已读状态。

**请求**

```
PUT /api/messages/{id}/read
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| id | number | 是 | 消息ID |

**响应**

```json
{
  "code": 200,
  "message": "标记成功",
  "data": null
}
```

---

### 4. 标记全部已读

将当前用户所有未读消息标记为已读。

**请求**

```
PUT /api/messages/read-all
```

**响应**

```json
{
  "code": 200,
  "message": "已标记全部为已读",
  "data": {
    "count": 5
  }
}
```

**响应字段说明**

| 字段 | 类型 | 说明 |
|-----|------|------|
| count | number | 本次标记为已读的消息数量 |

---

### 5. 删除消息

删除单条消息。

**请求**

```
DELETE /api/messages/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| id | number | 是 | 消息ID |

**响应**

```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

---

## 消息类型说明

| 类型 | 值 | 说明 | 触发场景 |
|-----|-----|------|---------|
| 活动报名 | activity_registration | 用户报名活动通知 | 有用户报名您发布的活动 |
| 帖子评论 | post_comment | 帖子收到评论通知 | 有用户评论您的帖子 |
| 评论回复 | comment_reply | 评论被回复通知 | 有用户回复您的评论 |
| 点赞通知 | post_like | 帖子被点赞通知 | 有用户点赞您的帖子 |
| 奖项通知 | award_notification | 获得奖项通知 | 管理平台录入个人奖项时通知获奖者 |

### 奖项通知详细说明

**触发场景**：管理员在后台管理系统的「AI使用达人管理」→「个人奖项设置」→「获奖者推荐」中，为用户设置获奖时触发。

**触发流程**：
1. 管理员进入管理后台的「获奖者推荐」页面
2. 选择月份，系统自动推荐该月活跃度高的用户
3. 管理员点击「评为获奖者」，选择奖项分类和具体奖项
4. 确认设置后，系统自动向获奖者发送消息通知

**消息内容示例**：
```
标题：恭喜您获得奖项！
内容：恭喜！您在 2026-01 荣获【创新突破】类别的「年度创新贡献奖」奖项
```

**奖项分类**：
| 分类 | 值 | 说明 |
|-----|-----|------|
| 创新突破 | innovation | 在AI创新应用方面有突出贡献 |
| 效率提升 | efficiency | 在提升工作效率方面有显著成效 |
| 最佳实践 | practice | 形成可复制推广的最佳实践案例 |
| 社区贡献 | community | 在社区活跃度、帮助他人方面表现突出 |

---

## 相关资源类型说明

| 类型 | 值 | 说明 | 跳转目标 |
|-----|-----|------|---------|
| 帖子 | post | 与帖子相关 | `/post/{relatedId}` |
| 活动 | activity | 与活动相关 | `/activity/{relatedId}` |
| 奖项 | award | 与奖项相关 | `/profile?tab=honors` |

### 评论和回复的跳转定位

对于帖子评论和回复消息，前端使用锚点定位到具体位置：

| 消息类型 | 跳转规则 | 示例 |
|---------|---------|------|
| post_comment | `/post/{relatedId}#comment-{commentId}` | `/post/1#comment-101` |
| comment_reply | `/post/{relatedId}#reply-{replyId}` | `/post/1#reply-1002` |

**前端跳转逻辑**：

```typescript
// 帖子评论通知
if (message.type === 'post_comment') {
  if (message.commentId) {
    router.push(`/post/${message.relatedId}#comment-${message.commentId}`)
  } else {
    router.push(`/post/${message.relatedId}`)
  }
}

// 评论回复通知
if (message.type === 'comment_reply') {
  if (message.replyId) {
    router.push(`/post/${message.relatedId}#reply-${message.replyId}`)
  } else if (message.commentId) {
    router.push(`/post/${message.relatedId}#comment-${message.commentId}`)
  } else {
    router.push(`/post/${message.relatedId}`)
  }
}
```

**帖子详情页锚点处理**：

帖子详情页需要监听路由变化，当URL包含锚点时自动滚动到对应位置：

```typescript
// 评论元素需要设置id
<div id="comment-{commentId}" class="comment-item">...</div>
<div id="reply-{replyId}" class="reply-item">...</div>

// 页面加载后滚动到锚点位置
onMounted(() => {
  if (route.hash) {
    const element = document.querySelector(route.hash)
    if (element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'center' })
      element.classList.add('highlight') // 高亮显示
    }
  }
})
```

---

## 前端使用示例

### 消息列表页面

```typescript
import {
  getUserMessages,
  markMessageAsRead,
  markAllMessagesAsRead,
  deleteMessage,
  getUnreadMessageCount,
  MessageType,
  type Message
} from '../utils/message'

// 加载消息列表
const loadMessages = () => {
  messages.value = getUserMessages(currentUserId.value)
}

// 获取未读消息数量
const loadUnreadCount = () => {
  unreadCount.value = getUnreadMessageCount(currentUserId.value)
}

// 标记单条消息已读
const handleMarkAsRead = (message: Message) => {
  markMessageAsRead(currentUserId.value, message.id)
  message.read = true
}

// 标记全部已读
const handleMarkAllRead = () => {
  markAllMessagesAsRead(currentUserId.value)
  messages.value.forEach(msg => msg.read = true)
  unreadCount.value = 0
}

// 删除消息
const handleDeleteMessage = (messageId: number) => {
  deleteMessage(currentUserId.value, messageId)
  messages.value = messages.value.filter(msg => msg.id !== messageId)
}
```

### 消息点击跳转

```typescript
const handleMessageClick = (message: Message) => {
  // 标记为已读
  if (!message.read) {
    handleMarkAsRead(message)
  }
  
  // 根据消息类型跳转
  switch (message.type) {
    case MessageType.ACTIVITY_REGISTRATION:
      router.push(`/activity/${message.relatedId}`)
      break
    case MessageType.POST_COMMENT:
    case MessageType.POST_LIKE:
      router.push(`/post/${message.relatedId}`)
      break
    case MessageType.COMMENT_REPLY:
      router.push(`/post/${message.relatedId}`)
      break
    case MessageType.AWARD_NOTIFICATION:
      router.push('/profile?tab=honors')
      break
  }
}
```

---

## 消息发送触发点

以下操作会自动发送消息通知：

| 操作 | 消息类型 | 接收者 | 触发位置 |
|------|---------|--------|---------|
| 用户报名活动 | activity_registration | 活动发布者 | 活动详情页 |
| 用户评论帖子 | post_comment | 帖子作者 | 帖子详情页 |
| 用户回复评论 | comment_reply | 被回复的评论者 | 帖子详情页 |
| 用户点赞帖子 | post_like | 帖子作者 | 帖子详情页/列表页 |
| **管理员录入奖项** | award_notification | 获奖用户 | **管理后台** |

### 发送活动报名消息示例

```typescript
import { sendActivityRegistrationMessage } from '../utils/message'

// 用户报名活动时发送消息
const handleActivityRegistration = async (activityId: number) => {
  // ...报名逻辑
  
  // 发送消息通知活动发布者
  sendActivityRegistrationMessage(
    activityId,           // 活动ID
    activityTitle,        // 活动标题
    activity.authorId,    // 活动发布者ID（接收消息）
    currentUser.id,       // 报名用户ID
    currentUser.name      // 报名用户名
  )
}
```

### 发送奖项通知消息示例

```typescript
import { sendAwardNotificationMessage } from '../utils/message'

// 管理员在后台设置用户获奖时发送消息
const handleConfirmSetAward = async () => {
  // ...设置获奖逻辑
  await setUserAward({
    userId: currentAwardUser.id,
    awardId: awardForm.awardId,
    awardName: selectedAward.name,
    awardDate: awardForm.awardDate,
    category: awardForm.category,
    year: year
  })
  
  // 发送奖项通知消息给获奖者
  sendAwardNotificationMessage(
    currentAwardUser.id,      // 获奖者用户ID
    currentAwardUser.name,    // 获奖者姓名
    awardForm.awardId,        // 奖项ID
    selectedAward.name,       // 奖项名称
    awardForm.category,       // 奖项分类（innovation/efficiency/practice/community）
    awardForm.awardDate       // 获奖时间（YYYY-MM格式）
  )
}
```

---

## 错误码说明

| 错误码 | 说明 |
|-------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未登录或登录已过期 |
| 403 | 无权限（尝试操作他人消息） |
| 404 | 消息不存在 |
| 500 | 服务器内部错误 |

---

## 数据字典

### MessageType 枚举

```typescript
export enum MessageType {
  ACTIVITY_REGISTRATION = 'activity_registration', // 活动报名
  POST_COMMENT = 'post_comment',                   // 帖子评论
  COMMENT_REPLY = 'comment_reply',                 // 评论回复
  POST_LIKE = 'post_like',                         // 帖子点赞
  AWARD_NOTIFICATION = 'award_notification'        // 奖项通知
}
```

### Message 接口

```typescript
export interface Message {
  id: number
  type: MessageType
  title: string
  content: string
  userId: number          // 接收消息的用户ID
  relatedId?: number      // 相关资源ID（帖子ID、活动ID等）
  relatedType?: string    // 相关资源类型（post、activity、award）
  commentId?: number      // 评论ID（POST_COMMENT和COMMENT_REPLY类型使用）
  replyId?: number        // 回复ID（COMMENT_REPLY类型使用）
  fromUserId?: number     // 发送者用户ID
  fromUserName?: string   // 发送者用户名
  read: boolean
  createdAt: string       // ISO 8601格式
  link?: string           // 自定义跳转链接（可选）
}
```
